<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘ä¿®å¤å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        
        .status-card.success {
            border-left-color: #28a745;
            background: #f8fff9;
        }
        
        .status-card.error {
            border-left-color: #dc3545;
            background: #fff8f8;
        }
        
        .status-card.warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            margin: 5px;
            min-width: 150px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .stat-item.highlight {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
        }
        
        .actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ› ï¸ è§†é¢‘ä¿®å¤å·¥å…·</h1>
            <p>è‡ªåŠ¨è¯Šæ–­å’Œä¿®å¤è§†é¢‘åŠ è½½é—®é¢˜</p>
        </div>
        
        <div class="content">
            <!-- çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="statusArea">
                <div class="status-card" id="statusCard">
                    <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
                    <p>æ­£åœ¨åˆå§‹åŒ–...</p>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats" id="statsArea">
                <div class="stat-item">
                    <div class="stat-number" id="totalVideos">0</div>
                    <div class="stat-label">æ€»è§†é¢‘æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalPlaylists">0</div>
                    <div class="stat-label">æ’­æ”¾åˆ—è¡¨æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="validVideos">0</div>
                    <div class="stat-label">æœ‰æ•ˆè§†é¢‘æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="issuesCount">0</div>
                    <div class="stat-label">å‘ç°é—®é¢˜</div>
                </div>
            </div>
            
            <!-- è¿›åº¦æ¡ -->
            <div class="progress-bar hidden" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="actions">
                <button class="btn btn-primary" onclick="diagnoseAll()">
                    <span class="icon">ğŸ”</span>é‡æ–°è¯Šæ–­
                </button>
                <button class="btn btn-success" onclick="fixAll()" id="fixAllBtn">
                    <span class="icon">ğŸ”§</span>ä¸€é”®ä¿®å¤
                </button>
                <button class="btn btn-warning" onclick="fixUrls()">
                    <span class="icon">ğŸ”—</span>ä¿®å¤URL
                </button>
                <button class="btn btn-warning" onclick="fixPlaylists()">
                    <span class="icon">ğŸ“‹</span>ä¿®å¤æ’­æ”¾åˆ—è¡¨
                </button>
                <button class="btn btn-danger" onclick="resetAll()">
                    <span class="icon">ğŸ—‘ï¸</span>æ¸…é™¤æ‰€æœ‰æ•°æ®
                </button>
            </div>
            
            <!-- æ—¥å¿—è¾“å‡º -->
            <div class="log" id="logArea">æ­£åœ¨åŠ è½½ä¿®å¤å·¥å…·...</div>
        </div>
    </div>

    <script>
        // è§†é¢‘ä¿®å¤å·¥å…·ç±»
        class VideoFixTool {
            constructor() {
                this.videos = [];
                this.playlists = [];
                this.collections = [];
                this.issues = [];
                this.isProcessing = false;
                this.log('ğŸš€ è§†é¢‘ä¿®å¤å·¥å…·åˆå§‹åŒ–...');
                this.loadData();
                this.diagnoseAll();
            }
            
            log(message) {
                const logArea = document.getElementById('logArea');
                const timestamp = new Date().toLocaleTimeString();
                logArea.textContent += `[${timestamp}] ${message}\n`;
                logArea.scrollTop = logArea.scrollHeight;
                console.log(message);
            }
            
            updateProgress(percent) {
                const progressBar = document.getElementById('progressBar');
                const progressFill = document.getElementById('progressFill');
                
                if (percent > 0) {
                    progressBar.classList.remove('hidden');
                    progressFill.style.width = percent + '%';
                } else {
                    progressBar.classList.add('hidden');
                }
            }
            
            updateStatus(message, type = 'info') {
                const statusCard = document.getElementById('statusCard');
                statusCard.className = `status-card ${type}`;
                statusCard.innerHTML = `
                    <h3>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'ğŸ“Š'} ç³»ç»ŸçŠ¶æ€</h3>
                    <p>${message}</p>
                `;
            }
            
            updateStats() {
                document.getElementById('totalVideos').textContent = this.videos.length;
                document.getElementById('totalPlaylists').textContent = this.playlists.length;
                document.getElementById('validVideos').textContent = this.videos.filter(v => v.file && v.file.size > 0).length;
                document.getElementById('issuesCount').textContent = this.issues.length;
                
                // é«˜äº®æ˜¾ç¤ºæœ‰é—®é¢˜çš„ç»Ÿè®¡
                const issuesElement = document.getElementById('issuesCount').parentElement;
                if (this.issues.length > 0) {
                    issuesElement.classList.add('highlight');
                } else {
                    issuesElement.classList.remove('highlight');
                }
            }
            
            loadData() {
                try {
                    this.videos = JSON.parse(localStorage.getItem('videos') || '[]');
                    this.playlists = JSON.parse(localStorage.getItem('playlists') || '[]');
                    this.collections = JSON.parse(localStorage.getItem('collections') || '[]');
                    
                    this.log(`âœ… æ•°æ®åŠ è½½å®Œæˆ: ${this.videos.length} ä¸ªè§†é¢‘, ${this.playlists.length} ä¸ªæ’­æ”¾åˆ—è¡¨`);
                    this.updateStats();
                } catch (error) {
                    this.log('âŒ æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
                    this.updateStatus('æ•°æ®åŠ è½½å¤±è´¥', 'error');
                }
            }
            
            saveData() {
                try {
                    localStorage.setItem('videos', JSON.stringify(this.videos));
                    localStorage.setItem('playlists', JSON.stringify(this.playlists));
                    localStorage.setItem('collections', JSON.stringify(this.collections));
                    this.log('âœ… æ•°æ®ä¿å­˜æˆåŠŸ');
                } catch (error) {
                    this.log('âŒ æ•°æ®ä¿å­˜å¤±è´¥: ' + error.message);
                }
            }
            
            diagnoseAll() {
                this.log('ğŸ” å¼€å§‹è¯Šæ–­é—®é¢˜...');
                this.issues = [];
                
                // æ£€æŸ¥è§†é¢‘æ•°æ®
                const videosWithoutFile = this.videos.filter(v => !v.file || !v.file.size);
                const videosWithoutUrl = this.videos.filter(v => !v.fileUrl);
                
                if (videosWithoutFile.length > 0) {
                    this.issues.push(`${videosWithoutFile.length} ä¸ªè§†é¢‘ç¼ºå°‘æ–‡ä»¶å¯¹è±¡`);
                }
                
                if (videosWithoutUrl.length > 0) {
                    this.issues.push(`${videosWithoutUrl.length} ä¸ªè§†é¢‘ç¼ºå°‘æ–‡ä»¶URL`);
                }
                
                // æ£€æŸ¥æ’­æ”¾åˆ—è¡¨åŒ¹é…
                let unmatchedItems = 0;
                this.playlists.forEach(playlist => {
                    playlist.items.forEach(item => {
                        const matchingVideo = this.videos.find(v => v.id === item.videoId);
                        if (!matchingVideo) {
                            unmatchedItems++;
                        }
                    });
                });
                
                if (unmatchedItems > 0) {
                    this.issues.push(`${unmatchedItems} ä¸ªæ’­æ”¾åˆ—è¡¨é¡¹ç›®æ‰¾ä¸åˆ°å¯¹åº”è§†é¢‘`);
                }
                
                this.updateStats();
                
                if (this.issues.length === 0) {
                    this.log('âœ… è¯Šæ–­å®Œæˆ: æœªå‘ç°é—®é¢˜');
                    this.updateStatus('ç³»ç»Ÿæ­£å¸¸ï¼Œæœªå‘ç°é—®é¢˜', 'success');
                } else {
                    this.log(`âš ï¸ è¯Šæ–­å®Œæˆ: å‘ç° ${this.issues.length} ä¸ªé—®é¢˜`);
                    this.issues.forEach(issue => this.log(`  - ${issue}`));
                    this.updateStatus(`å‘ç° ${this.issues.length} ä¸ªé—®é¢˜éœ€è¦ä¿®å¤`, 'warning');
                }
            }
            
            async fixVideoUrls() {
                this.log('ğŸ”§ å¼€å§‹ä¿®å¤è§†é¢‘URL...');
                this.updateProgress(10);
                
                let fixed = 0;
                const total = this.videos.length;
                
                for (let i = 0; i < this.videos.length; i++) {
                    const video = this.videos[i];
                    
                    if (video.file && video.file.size > 0) {
                        if (!video.fileUrl || video.fileUrl.startsWith('blob:')) {
                            try {
                                // æ¸…é™¤æ—§URL
                                if (video.fileUrl && video.fileUrl.startsWith('blob:')) {
                                    URL.revokeObjectURL(video.fileUrl);
                                }
                                
                                // åˆ›å»ºæ–°URL
                                video.fileUrl = URL.createObjectURL(video.file);
                                fixed++;
                                this.log(`âœ… ä¿®å¤è§†é¢‘ ${i + 1}: ${video.name}`);
                            } catch (error) {
                                this.log(`âŒ ä¿®å¤è§†é¢‘ ${i + 1} å¤±è´¥: ${error.message}`);
                            }
                        }
                    }
                    
                    this.updateProgress(10 + (i / total) * 40);
                    await new Promise(resolve => setTimeout(resolve, 50)); // æ·»åŠ å»¶è¿Ÿä»¥æ˜¾ç¤ºè¿›åº¦
                }
                
                this.log(`ğŸ‰ URLä¿®å¤å®Œæˆï¼Œå…±ä¿®å¤ ${fixed} ä¸ªè§†é¢‘`);
                return fixed;
            }
            
            async fixPlaylistMatching() {
                this.log('ğŸ”§ å¼€å§‹ä¿®å¤æ’­æ”¾åˆ—è¡¨åŒ¹é…...');
                this.updateProgress(50);
                
                let fixed = 0;
                const totalPlaylists = this.playlists.length;
                
                for (let pIndex = 0; pIndex < this.playlists.length; pIndex++) {
                    const playlist = this.playlists[pIndex];
                    
                    for (let iIndex = 0; iIndex < playlist.items.length; iIndex++) {
                        const item = playlist.items[iIndex];
                        const matchingVideo = this.videos.find(v => v.id === item.videoId);
                        
                        if (!matchingVideo) {
                            this.log(`ä¿®å¤æ’­æ”¾åˆ—è¡¨ ${pIndex + 1} é¡¹ç›® ${iIndex + 1}: ${item.videoId}`);
                            
                            // ç­–ç•¥1: ç´¢å¼•åŒ¹é…
                            const videoIndex = parseInt(item.videoId);
                            if (!isNaN(videoIndex) && videoIndex >= 0 && videoIndex < this.videos.length) {
                                item.videoId = this.videos[videoIndex].id;
                                fixed++;
                                this.log(`  âœ… ç´¢å¼•åŒ¹é…æˆåŠŸ`);
                                continue;
                            }
                            
                            // ç­–ç•¥2: éƒ¨åˆ†åŒ¹é…
                            const partialMatch = this.videos.find(v => 
                                v.id.includes(item.videoId) || item.videoId.includes(v.id)
                            );
                            if (partialMatch) {
                                item.videoId = partialMatch.id;
                                fixed++;
                                this.log(`  âœ… éƒ¨åˆ†åŒ¹é…æˆåŠŸ`);
                                continue;
                            }
                            
                            // ç­–ç•¥3: ä½¿ç”¨ç¬¬ä¸€ä¸ªè§†é¢‘
                            if (this.videos.length > 0) {
                                item.videoId = this.videos[0].id;
                                fixed++;
                                this.log(`  âš ï¸ ä½¿ç”¨å¤‡ç”¨è§†é¢‘`);
                            }
                        }
                    }
                    
                    this.updateProgress(50 + (pIndex / totalPlaylists) * 40);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                this.log(`ğŸ‰ æ’­æ”¾åˆ—è¡¨ä¿®å¤å®Œæˆï¼Œå…±ä¿®å¤ ${fixed} ä¸ªé¡¹ç›®`);
                return fixed;
            }
            
            async fixAll() {
                if (this.isProcessing) {
                    this.log('âš ï¸ æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…...');
                    return;
                }
                
                this.isProcessing = true;
                const fixAllBtn = document.getElementById('fixAllBtn');
                fixAllBtn.disabled = true;
                fixAllBtn.innerHTML = '<span class="loading"></span>ä¿®å¤ä¸­...';
                
                try {
                    this.log('ğŸ› ï¸ å¼€å§‹ä¸€é”®ä¿®å¤...');
                    this.updateStatus('æ­£åœ¨ä¿®å¤ä¸­ï¼Œè¯·ç­‰å¾…...', 'info');
                    
                    const startTime = Date.now();
                    
                    // ä¿®å¤è§†é¢‘URL
                    const urlsFixed = await this.fixVideoUrls();
                    
                    // ä¿®å¤æ’­æ”¾åˆ—è¡¨
                    const playlistsFixed = await this.fixPlaylistMatching();
                    
                    // ä¿å­˜æ•°æ®
                    this.updateProgress(90);
                    this.saveData();
                    
                    // é‡æ–°è¯Šæ–­
                    this.updateProgress(95);
                    this.diagnoseAll();
                    
                    this.updateProgress(100);
                    
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    this.log(`ğŸ‰ ä¿®å¤å®Œæˆï¼ç”¨æ—¶ ${duration}ms`);
                    this.log(`ğŸ“Š ä¿®å¤ç»Ÿè®¡: ${urlsFixed} ä¸ªURL, ${playlistsFixed} ä¸ªæ’­æ”¾åˆ—è¡¨é¡¹ç›®`);
                    
                    if (this.issues.length === 0) {
                        this.updateStatus('ä¿®å¤å®Œæˆï¼æ‰€æœ‰é—®é¢˜å·²è§£å†³', 'success');
                        
                        if (confirm('ä¿®å¤å®Œæˆï¼æ˜¯å¦ç«‹å³åˆ·æ–°é¡µé¢ä»¥åº”ç”¨ä¿®å¤ï¼Ÿ')) {
                            window.location.reload();
                        }
                    } else {
                        this.updateStatus(`ä¿®å¤å®Œæˆï¼Œä½†ä»æœ‰ ${this.issues.length} ä¸ªé—®é¢˜æœªè§£å†³`, 'warning');
                    }
                    
                } catch (error) {
                    this.log('âŒ ä¿®å¤è¿‡ç¨‹ä¸­å‡ºé”™: ' + error.message);
                    this.updateStatus('ä¿®å¤å¤±è´¥: ' + error.message, 'error');
                } finally {
                    this.isProcessing = false;
                    fixAllBtn.disabled = false;
                    fixAllBtn.innerHTML = '<span class="icon">ğŸ”§</span>ä¸€é”®ä¿®å¤';
                    this.updateProgress(0);
                }
            }
            
            resetAll() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰è§†é¢‘ã€æ’­æ”¾åˆ—è¡¨å’Œåˆè¾‘ï¼Œä¸”æ— æ³•æ¢å¤ï¼')) {
                    if (confirm('å†æ¬¡ç¡®è®¤ï¼šè¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                        localStorage.removeItem('videos');
                        localStorage.removeItem('playlists');
                        localStorage.removeItem('collections');
                        
                        this.log('ğŸ—‘ï¸ æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
                        this.updateStatus('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'success');
                        
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                }
            }
        }
        
        // å…¨å±€å˜é‡
        let fixTool;
        
        // åˆå§‹åŒ–
        window.onload = function() {
            fixTool = new VideoFixTool();
        };
        
        // å…¨å±€å‡½æ•°
        function diagnoseAll() {
            fixTool.diagnoseAll();
        }
        
        function fixAll() {
            fixTool.fixAll();
        }
        
        function fixUrls() {
            fixTool.fixVideoUrls().then(() => {
                fixTool.saveData();
                fixTool.diagnoseAll();
            });
        }
        
        function fixPlaylists() {
            fixTool.fixPlaylistMatching().then(() => {
                fixTool.saveData();
                fixTool.diagnoseAll();
            });
        }
        
        function resetAll() {
            fixTool.resetAll();
        }
    </script>
</body>
</html>
